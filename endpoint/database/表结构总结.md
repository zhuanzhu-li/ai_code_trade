# 量化交易系统数据库表结构总结

## 表概览

| 序号 | 表名 | 中文名称 | 主要功能 | 记录数预估 |
|------|------|----------|----------|------------|
| 1 | users | 用户表 | 用户基本信息管理 | 1K-10K |
| 2 | portfolios | 投资组合表 | 投资组合管理 | 5K-50K |
| 3 | positions | 持仓表 | 持仓信息管理 | 50K-500K |
| 4 | trades | 交易记录表 | 交易记录存储 | 1M-10M |
| 5 | orders | 订单表 | 订单管理 | 100K-1M |
| 6 | strategies | 策略表 | 交易策略配置 | 1K-10K |
| 7 | strategy_executions | 策略执行表 | 策略执行实例 | 10K-100K |
| 8 | symbols | 标的信息表 | 交易标的信息 | 1K-10K |
| 9 | market_data | 市场数据表 | 市场行情数据 | 100M-1B |
| 10 | risk_rules | 风险规则表 | 风险管理规则 | 1K-10K |
| 11 | risk_alerts | 风险警报表 | 风险警报记录 | 100K-1M |
| 12 | schema_versions | 版本管理表 | 数据库版本控制 | 10-100 |

## 核心表字段说明

### 1. 用户表 (users)
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(80) UNIQUE NOT NULL,
    email VARCHAR(120) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 2. 投资组合表 (portfolios)
```sql
CREATE TABLE portfolios (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    initial_capital DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    current_value DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    cash_balance DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### 3. 持仓表 (positions)
```sql
CREATE TABLE positions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    portfolio_id INT NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    quantity DECIMAL(15,8) NOT NULL DEFAULT 0.00000000,
    average_price DECIMAL(15,8) NOT NULL DEFAULT 0.00000000,
    current_price DECIMAL(15,8) NOT NULL DEFAULT 0.00000000,
    unrealized_pnl DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    realized_pnl DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (portfolio_id) REFERENCES portfolios(id) ON DELETE CASCADE,
    UNIQUE KEY uk_portfolio_symbol (portfolio_id, symbol)
);
```

### 4. 交易记录表 (trades)
```sql
CREATE TABLE trades (
    id INT PRIMARY KEY AUTO_INCREMENT,
    portfolio_id INT NOT NULL,
    strategy_execution_id INT NULL,
    symbol VARCHAR(20) NOT NULL,
    side VARCHAR(10) NOT NULL,
    quantity DECIMAL(15,8) NOT NULL,
    price DECIMAL(15,8) NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    fee DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    pnl DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    status VARCHAR(20) NOT NULL DEFAULT 'completed',
    executed_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (portfolio_id) REFERENCES portfolios(id) ON DELETE CASCADE,
    FOREIGN KEY (strategy_execution_id) REFERENCES strategy_executions(id) ON DELETE SET NULL
);
```

### 5. 订单表 (orders)
```sql
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    portfolio_id INT NOT NULL,
    strategy_execution_id INT NULL,
    symbol VARCHAR(20) NOT NULL,
    side VARCHAR(10) NOT NULL,
    order_type VARCHAR(20) NOT NULL,
    quantity DECIMAL(15,8) NOT NULL,
    price DECIMAL(15,8) NULL,
    stop_price DECIMAL(15,8) NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    filled_quantity DECIMAL(15,8) NOT NULL DEFAULT 0.00000000,
    average_fill_price DECIMAL(15,8) NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (portfolio_id) REFERENCES portfolios(id) ON DELETE CASCADE,
    FOREIGN KEY (strategy_execution_id) REFERENCES strategy_executions(id) ON DELETE SET NULL
);
```

### 6. 策略表 (strategies)
```sql
CREATE TABLE strategies (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    strategy_type VARCHAR(50) NOT NULL,
    parameters TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### 7. 策略执行表 (strategy_executions)
```sql
CREATE TABLE strategy_executions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    strategy_id INT NOT NULL,
    portfolio_id INT NOT NULL,
    start_time DATETIME NOT NULL,
    end_time DATETIME NULL,
    is_active BOOLEAN DEFAULT TRUE,
    initial_capital DECIMAL(15,2) NOT NULL,
    current_value DECIMAL(15,2) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (strategy_id) REFERENCES strategies(id) ON DELETE CASCADE,
    FOREIGN KEY (portfolio_id) REFERENCES portfolios(id) ON DELETE CASCADE
);
```

### 8. 标的信息表 (symbols)
```sql
CREATE TABLE symbols (
    id INT PRIMARY KEY AUTO_INCREMENT,
    symbol VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    exchange VARCHAR(50),
    asset_type VARCHAR(20) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 9. 市场数据表 (market_data)
```sql
CREATE TABLE market_data (
    id INT PRIMARY KEY AUTO_INCREMENT,
    symbol VARCHAR(20) NOT NULL,
    timestamp DATETIME NOT NULL,
    open_price DECIMAL(15,8) NOT NULL,
    high_price DECIMAL(15,8) NOT NULL,
    low_price DECIMAL(15,8) NOT NULL,
    close_price DECIMAL(15,8) NOT NULL,
    volume DECIMAL(20,8) NOT NULL DEFAULT 0.00000000,
    interval_type VARCHAR(10) NOT NULL DEFAULT '1d',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_symbol_timestamp_interval (symbol, timestamp, interval_type)
);
```

### 10. 风险规则表 (risk_rules)
```sql
CREATE TABLE risk_rules (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    portfolio_id INT NULL,
    rule_type VARCHAR(50) NOT NULL,
    rule_name VARCHAR(100) NOT NULL,
    parameters TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (portfolio_id) REFERENCES portfolios(id) ON DELETE CASCADE
);
```

### 11. 风险警报表 (risk_alerts)
```sql
CREATE TABLE risk_alerts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    portfolio_id INT NULL,
    risk_rule_id INT NULL,
    alert_type VARCHAR(50) NOT NULL,
    message TEXT NOT NULL,
    severity VARCHAR(20) NOT NULL DEFAULT 'medium',
    is_read BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (portfolio_id) REFERENCES portfolios(id) ON DELETE CASCADE,
    FOREIGN KEY (risk_rule_id) REFERENCES risk_rules(id) ON DELETE SET NULL
);
```

### 12. 版本管理表 (schema_versions)
```sql
CREATE TABLE schema_versions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    version VARCHAR(20) UNIQUE NOT NULL,
    description TEXT,
    applied_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    checksum VARCHAR(64)
);
```

## 关键索引

### 性能关键索引
1. **用户相关查询**
   - `users.username` - 用户登录
   - `users.email` - 邮箱验证

2. **投资组合相关查询**
   - `portfolios.user_id` - 用户投资组合列表
   - `positions.portfolio_id` - 投资组合持仓

3. **交易相关查询**
   - `trades.portfolio_id` - 投资组合交易记录
   - `trades.symbol` - 标的交易记录
   - `trades.executed_at` - 时间范围查询

4. **市场数据查询**
   - `market_data.symbol` - 标的行情数据
   - `market_data.timestamp` - 时间范围查询
   - `market_data.symbol_timestamp_interval` - 复合唯一索引

5. **风险管理查询**
   - `risk_alerts.user_id` - 用户警报
   - `risk_alerts.is_read` - 未读警报

## 数据类型说明

### 数值类型
- `INT` - 整数ID和计数
- `DECIMAL(15,2)` - 金额字段（支持到万亿级别）
- `DECIMAL(15,8)` - 价格字段（支持高精度价格）
- `DECIMAL(20,8)` - 数量字段（支持大数量和高精度）

### 字符串类型
- `VARCHAR(20)` - 标的代码
- `VARCHAR(50)` - 类型字段
- `VARCHAR(100)` - 名称字段
- `VARCHAR(255)` - 密码哈希
- `TEXT` - 描述和参数字段

### 时间类型
- `DATETIME` - 所有时间戳字段
- `CURRENT_TIMESTAMP` - 默认创建时间
- `ON UPDATE CURRENT_TIMESTAMP` - 自动更新时间

## 外键关系

### 主要外键约束
1. `portfolios.user_id` → `users.id`
2. `positions.portfolio_id` → `portfolios.id`
3. `trades.portfolio_id` → `portfolios.id`
4. `trades.strategy_execution_id` → `strategy_executions.id`
5. `orders.portfolio_id` → `portfolios.id`
6. `orders.strategy_execution_id` → `strategy_executions.id`
7. `strategies.user_id` → `users.id`
8. `strategy_executions.strategy_id` → `strategies.id`
9. `strategy_executions.portfolio_id` → `portfolios.id`
10. `risk_rules.user_id` → `users.id`
11. `risk_rules.portfolio_id` → `portfolios.id`
12. `risk_alerts.user_id` → `users.id`
13. `risk_alerts.portfolio_id` → `portfolios.id`
14. `risk_alerts.risk_rule_id` → `risk_rules.id`

### 级联删除规则
- 删除用户 → 级联删除所有相关数据
- 删除投资组合 → 级联删除持仓
- 删除策略 → 级联删除执行记录
- 删除风险规则 → 设置相关警报为NULL

## 数据完整性约束

### 唯一性约束
- `users.username` - 用户名唯一
- `users.email` - 邮箱唯一
- `symbols.symbol` - 标的代码唯一
- `portfolios.portfolio_id + symbol` - 投资组合内标的唯一
- `market_data.symbol + timestamp + interval_type` - 市场数据唯一

### 非空约束
- 所有ID字段
- 关键业务字段（名称、价格、数量等）
- 时间戳字段

### 默认值
- `is_active` - 默认为TRUE
- `status` - 根据业务设置默认状态
- `created_at` - 默认为当前时间
- 数值字段 - 根据业务设置合理默认值

---

此总结文档提供了量化交易系统数据库表结构的快速参考，便于开发人员理解和使用。
