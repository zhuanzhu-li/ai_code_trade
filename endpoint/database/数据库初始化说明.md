# 数据库初始化说明

## 概述

本文档说明如何初始化量化交易系统的数据库，包括表结构创建、初始数据插入和索引优化。

## 初始化步骤

### 1. 环境准备

#### 1.1 数据库要求
- MySQL 8.0 或更高版本
- 支持utf8mb4字符集
- 支持JSON数据类型
- 支持外键约束

#### 1.2 权限要求
- 创建数据库权限
- 创建表权限
- 创建索引权限
- 插入数据权限

### 2. 数据库创建

```sql
-- 创建数据库
CREATE DATABASE ai_trading_system 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE ai_trading_system;

-- 设置时区
SET TIME_ZONE = '+00:00';
```

### 3. 表结构创建

#### 3.1 执行顺序
按照以下顺序执行SQL脚本，确保外键约束正确：

1. **基础表**（无外键依赖）
   - `users` - 用户表
   - `symbols` - 标的信息表
   - `schema_versions` - 版本管理表

2. **一级依赖表**（依赖基础表）
   - `portfolios` - 投资组合表
   - `strategies` - 策略表
   - `risk_rules` - 风险规则表

3. **二级依赖表**（依赖一级表）
   - `positions` - 持仓表
   - `strategy_executions` - 策略执行表
   - `market_data` - 市场数据表
   - `risk_alerts` - 风险警报表

4. **三级依赖表**（依赖二级表）
   - `trades` - 交易记录表
   - `orders` - 订单表

#### 3.2 执行脚本
```bash
# 执行完整的schema.sql文件
mysql -u username -p ai_trading_system < schema.sql
```

### 4. 初始数据插入

#### 4.1 系统数据
```sql
-- 插入版本记录
INSERT INTO schema_versions (version, description) 
VALUES ('v1.0.0', '初始数据库结构创建');

-- 插入常用标的信息
INSERT INTO symbols (symbol, name, exchange, asset_type) VALUES
('AAPL', 'Apple Inc.', 'NASDAQ', 'stock'),
('GOOGL', 'Alphabet Inc.', 'NASDAQ', 'stock'),
('MSFT', 'Microsoft Corporation', 'NASDAQ', 'stock'),
('TSLA', 'Tesla Inc.', 'NASDAQ', 'stock'),
('AMZN', 'Amazon.com Inc.', 'NASDAQ', 'stock'),
('BTC-USD', 'Bitcoin USD', 'Crypto', 'crypto'),
('ETH-USD', 'Ethereum USD', 'Crypto', 'crypto'),
('BNB-USD', 'Binance Coin USD', 'Crypto', 'crypto');
```

#### 4.2 测试用户数据
```sql
-- 插入测试用户
INSERT INTO users (username, email, password_hash, is_active) VALUES
('admin', 'admin@example.com', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj4J/HSyK8mG', TRUE),
('testuser', 'test@example.com', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj4J/HSyK8mG', TRUE);

-- 插入测试投资组合
INSERT INTO portfolios (user_id, name, description, initial_capital, current_value, cash_balance) VALUES
(1, '默认投资组合', '管理员默认投资组合', 100000.00, 100000.00, 100000.00),
(2, '测试投资组合', '测试用户投资组合', 50000.00, 50000.00, 50000.00);
```

### 5. 索引优化

#### 5.1 检查索引状态
```sql
-- 查看所有表的索引
SHOW INDEX FROM users;
SHOW INDEX FROM portfolios;
SHOW INDEX FROM trades;
-- ... 其他表
```

#### 5.2 性能分析
```sql
-- 分析表统计信息
ANALYZE TABLE users;
ANALYZE TABLE portfolios;
ANALYZE TABLE trades;
-- ... 其他表
```

### 6. 权限配置

#### 6.1 创建应用用户
```sql
-- 创建应用数据库用户
CREATE USER 'trading_app'@'%' IDENTIFIED BY 'secure_password';

-- 授予必要权限
GRANT SELECT, INSERT, UPDATE, DELETE ON ai_trading_system.* TO 'trading_app'@'%';
GRANT CREATE TEMPORARY TABLES ON ai_trading_system.* TO 'trading_app'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

#### 6.2 创建只读用户
```sql
-- 创建只读用户（用于报表查询）
CREATE USER 'trading_readonly'@'%' IDENTIFIED BY 'readonly_password';

-- 授予只读权限
GRANT SELECT ON ai_trading_system.* TO 'trading_readonly'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 7. 备份配置

#### 7.1 创建备份脚本
```bash
#!/bin/bash
# backup_database.sh

DB_NAME="ai_trading_system"
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DB_NAME}_${DATE}.sql"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
mysqldump -u root -p \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  $DB_NAME > $BACKUP_FILE

# 压缩备份文件
gzip $BACKUP_FILE

echo "备份完成: ${BACKUP_FILE}.gz"
```

#### 7.2 设置定时备份
```bash
# 添加到crontab
# 每天凌晨2点执行备份
0 2 * * * /path/to/backup_database.sh

# 每周日执行完整备份
0 3 * * 0 /path/to/backup_database.sh --full
```

### 8. 监控配置

#### 8.1 性能监控
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';

-- 启用查询日志
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/var/log/mysql/general.log';
```

#### 8.2 空间监控
```sql
-- 查看数据库大小
SELECT 
    table_schema AS 'Database',
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'ai_trading_system'
GROUP BY table_schema;

-- 查看各表大小
SELECT 
    table_name AS 'Table',
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'ai_trading_system'
ORDER BY (data_length + index_length) DESC;
```

### 9. 验证初始化

#### 9.1 表结构验证
```sql
-- 检查所有表是否创建成功
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'ai_trading_system'
ORDER BY table_name;

-- 检查外键约束
SELECT 
    CONSTRAINT_NAME,
    TABLE_NAME,
    COLUMN_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME
FROM information_schema.KEY_COLUMN_USAGE 
WHERE TABLE_SCHEMA = 'ai_trading_system' 
AND REFERENCED_TABLE_NAME IS NOT NULL;
```

#### 9.2 数据验证
```sql
-- 检查初始数据
SELECT COUNT(*) as user_count FROM users;
SELECT COUNT(*) as symbol_count FROM symbols;
SELECT COUNT(*) as portfolio_count FROM portfolios;

-- 检查版本记录
SELECT * FROM schema_versions;
```

### 10. 常见问题解决

#### 10.1 字符集问题
```sql
-- 检查字符集
SHOW VARIABLES LIKE 'character_set%';
SHOW VARIABLES LIKE 'collation%';

-- 修改字符集（如果需要）
ALTER DATABASE ai_trading_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 10.2 外键约束问题
```sql
-- 检查外键约束状态
SELECT 
    CONSTRAINT_NAME,
    TABLE_NAME,
    CONSTRAINT_TYPE
FROM information_schema.TABLE_CONSTRAINTS 
WHERE TABLE_SCHEMA = 'ai_trading_system' 
AND CONSTRAINT_TYPE = 'FOREIGN KEY';

-- 临时禁用外键检查
SET FOREIGN_KEY_CHECKS = 0;
-- 执行操作
SET FOREIGN_KEY_CHECKS = 1;
```

#### 10.3 性能问题
```sql
-- 检查索引使用情况
EXPLAIN SELECT * FROM trades WHERE portfolio_id = 1;

-- 优化表
OPTIMIZE TABLE trades;
OPTIMIZE TABLE market_data;
```

## 维护建议

### 1. 定期维护
- 每周执行OPTIMIZE TABLE
- 每月检查索引使用情况
- 每季度清理历史数据

### 2. 监控指标
- 数据库连接数
- 查询响应时间
- 存储空间使用率
- 慢查询数量

### 3. 备份策略
- 每日增量备份
- 每周全量备份
- 每月归档备份
- 异地备份存储

---

此文档提供了完整的数据库初始化指南，确保系统能够正确部署和运行。
